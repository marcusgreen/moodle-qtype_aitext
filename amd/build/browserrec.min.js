define("qtype_aitext/browserrec",["jquery","core/log"],(function($,log){return log.debug("qtype_aitext browser speech rec: initialising"),{recognition:null,recognizing:!1,final_transcript:"",interim_transcript:"",start_timestamp:0,lang:"en-US",interval:0,browsertype:"",clone:function(){return $.extend(!0,{},this)},will_work_ok:function(opts){void 0!==navigator.brave&&(this.browsertype="brave"),navigator.userAgent.toLowerCase().indexOf("edg/")>-1&&""===this.browsertype&&(this.browsertype="edge");var has_chrome=navigator.userAgent.indexOf("Chrome")>-1;navigator.userAgent.indexOf("Safari")>-1&&!has_chrome&&""===this.browsertype&&(this.browsertype="safari");var hasspeechrec="webkitSpeechRecognition"in window||"SpeechRecognition"in window;return hasspeechrec&&""===this.browsertype&&has_chrome&&(this.browsertype="chrome"),hasspeechrec},init:function(lang,waveheight,uniqueid){log.debug("bh : "+uniqueid);var SpeechRecognition=SpeechRecognition||webkitSpeechRecognition;this.recognition=new SpeechRecognition,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.lang=lang,this.waveHeight=waveheight,this.uniqueid=uniqueid,this.prepare_html(),this.register_events()},prepare_html:function(){this.canvas=$("."+this.uniqueid+"_waveform"),this.canvasCtx=this.canvas[0].getContext("2d")},set_grammar:function(grammar){var SpeechGrammarList=SpeechGrammarList||webkitSpeechGrammarList;if(SpeechGrammarList){var speechRecognitionList=new SpeechGrammarList;speechRecognitionList.addFromString(grammar,1),this.recognition.grammars=speechRecognitionList}},start:function(){var that=this;this.recognizing||(this.recognizing=!0,this.final_transcript="",this.interim_transcript="",this.recognition.lang=this.lang,this.recognition.start(),this.start_timestamp=Date.now(),that.onstart(),that.interval=setInterval((function(){that.drawWave()}),100))},stop:function(){var that=this;this.recognizing=!1,this.recognition.stop(),clearInterval(this.interval),this.canvasCtx.clearRect(0,0,2*this.canvas.width(),2*this.waveHeight),setTimeout((function(){that.onfinalspeechcapture(that.final_transcript)}),1e3),this.onend()},register_events:function(){var recognition=this.recognition,that=this;recognition.onerror=function(event){"no-speech"==event.error&&log.debug("info_no_speech"),"audio-capture"==event.error&&log.debug("info_no_microphone"),"not-allowed"==event.error&&(event.timeStamp-that.start_timestamp<100?log.debug("info_blocked"):log.debug("info_denied")),that.onerror({error:{name:event.error}})},recognition.onend=function(){that.recognizing&&that.recognition.start()},recognition.onresult=function(event){for(var i=event.resultIndex;i<event.results.length;++i)if(event.results[i].isFinal)that.final_transcript+=event.results[i][0].transcript;else{var provisional_transcript=that.final_transcript+event.results[i][0].transcript;if(provisional_transcript.length<that.interim_transcript.length)return;that.interim_transcript=provisional_transcript,that.oninterimspeechcapture(that.interim_transcript)}}},drawWave:function(){var width=2*this.canvas.width();this.canvasCtx.fillStyle="white",this.canvasCtx.fillRect(0,0,width,2*this.waveHeight),this.canvasCtx.lineWidth=5,this.canvasCtx.strokeStyle="gray",this.canvasCtx.beginPath();for(var slicewaveWidth=width/4096,x=0,i=0;i<4096;i++){var y=(64*Math.random()+96)/128*this.waveHeight;0===i||this.canvasCtx.lineTo(x,y),x+=slicewaveWidth}this.canvasCtx.lineTo(width,this.waveHeight),this.canvasCtx.stroke()},onstart:function(){log.debug("started")},onerror:function(){log.debug("error")},onend:function(){log.debug("end")},onfinalspeechcapture:function(speechtext){log.debug(speechtext)},oninterimspeechcapture:function(speechtext){}}}));

//# sourceMappingURL=browserrec.min.js.map